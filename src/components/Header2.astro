<header
  id="mainHeader"
  class="sticky top-0 z-50 border-b bg-white border-slate-200 transition-transform duration-300 ease-in-out"
>
  <div
    id="headerContent"
    class="flex justify-between items-center p-4 relative z-20"
  >
    <div class="font-black text-xl tracking-tighter">
      <a href="/"> LOGO </a>
    </div>
    <nav class="md:block hidden">
      <a
        href="#"
        class="px-3 py-2 text-sm font-medium hover:bg-gray-100 rounded transition-colors"
      >
        SHOP ALL
      </a>
      <a
        href="#"
        class="px-3 py-2 text-sm font-medium hover:bg-gray-100 rounded transition-colors"
      >
        LOCATIONS
      </a>
      <a
        href="#"
        class="px-3 py-2 text-sm font-medium hover:bg-gray-100 rounded transition-colors"
      >
        REWARDS
      </a>
    </nav>
    <button
      id="menuBtn"
      class="group w-5 h-5 flex flex-col justify-center items-center relative cursor-pointer md:hidden"
      aria-label="Toggle Menu"
    >
      <span
        class="w-full h-0.5 bg-black rounded-full transition-all duration-300 absolute top-0.5 group-[.active]:top-1/2 group-[.active]:-translate-y-1/2 group-[.active]:rotate-45"
      ></span>

      <span
        class="w-full h-0.5 bg-black rounded-full transition-all duration-300 absolute top-1/2 -translate-y-1/2 group-[.active]:opacity-0"
      ></span>

      <span
        class="w-full h-0.5 bg-black rounded-full transition-all duration-300 absolute bottom-0.5 group-[.active]:bottom-1/2 group-[.active]:translate-y-1/2 group-[.active]:-rotate-45"
      ></span>
    </button>
  </div>

  <header-menu-drawer
    id="mobileNav"
    class="hidden absolute right-0 w-80 bg-white border-slate-200 border-t border-l transition-transform duration-300 translate-x-full"
    style="display: none;"
    role="dialog"
  >
    <div class="flex flex-col h-full">
      <nav class="p-5 flex flex-col gap-6 font-bold text-lg flex-1">
        <a href="#" class="hover:text-red-600">SHOP ALL</a>
        <a href="#" class="hover:text-red-600">LOCATIONS</a>
        <a href="#" class="hover:text-red-600">REWARDS</a>
      </nav>
      <footer class="p-5 bg-slate-50 border-slate-200 border-t">
        footer of the menu
      </footer>
    </div>
  </header-menu-drawer>
</header>

<script>
  // DOM Elements
  const mainHeader = document.getElementById("mainHeader") as HTMLElement;
  const menuBtn = document.getElementById("menuBtn") as HTMLElement;
  const mobileNav = document.getElementById("mobileNav") as HTMLElement;
  const headerContent = document.getElementById("headerContent") as HTMLElement;
  const navLinks = mobileNav.querySelectorAll("a") as NodeListOf<HTMLElement>;

  // --- 1. NEW: Scroll Logic Variables ---
  let lastScrollY = window.scrollY;
  const scrollThreshold = 50; // Buffer to prevent jitter on tiny scrolls

  // --- 2. NEW: Scroll Handler ---
  window.addEventListener("scroll", () => {
    const currentScrollY = window.scrollY;
    const isMenuOpen = menuBtn.classList.contains("active");

    // Don't hide the header if the mobile menu is open!
    if (isMenuOpen) return;

    // Check if we scrolled enough to trigger the change
    if (Math.abs(currentScrollY - lastScrollY) < scrollThreshold) return;

    // Logic: Hide on scroll down, Show on scroll up
    if (currentScrollY > lastScrollY && currentScrollY > 75) {
      // Scrolling Down & not at very top
      mainHeader.classList.add("-translate-y-full");
    } else {
      // Scrolling Up
      mainHeader.classList.remove("-translate-y-full");
    }

    lastScrollY = currentScrollY;
  });

  // --- Existing Logic (Slightly Modified) ---

  const updateMenuLayout = () => {
    if (!headerContent || !mobileNav) return;
    const rect = headerContent.getBoundingClientRect();
    mobileNav.style.height = `calc(100dvh - ${rect.bottom}px)`;
  };

  function openNav() {
    // CRITICAL: Ensure header is visible before calculating layout
    mainHeader.classList.remove("-translate-y-full");

    updateMenuLayout();

    mobileNav.style.display = "block";
    mobileNav.classList.remove("hidden");

    requestAnimationFrame(() => {
      mobileNav.classList.remove("translate-x-full");
      menuBtn.classList.add("active");
      document.body.style.overflow = "hidden";
    });

    document.addEventListener("click", handleOutsideClick);
    document.addEventListener("keydown", handleEscape);
    document.addEventListener("touchstart", handleOutsideClick);
    window.addEventListener("resize", handleResize);
    // Note: We keep this to update height if window resizes,
    // but the main scroll hide/show is handled by the new listener above.
    window.addEventListener("scroll", updateMenuLayout);
  }

  function closeNav() {
    document.body.style.overflow = "";
    menuBtn.classList.remove("active");
    mobileNav.classList.add("translate-x-full");

    mobileNav.addEventListener(
      "transitionend",
      () => {
        if (mobileNav.classList.contains("translate-x-full")) {
          mobileNav.style.display = "none";
          mobileNav.classList.add("hidden");
        }
      },
      { once: true },
    );

    document.removeEventListener("click", handleOutsideClick);
    document.removeEventListener("touchstart", handleOutsideClick);
    document.removeEventListener("keydown", handleEscape);
    window.removeEventListener("resize", handleResize);
    // Clean up
    window.removeEventListener("scroll", updateMenuLayout);
  }

  function handleOutsideClick(e: any) {
    if (!mobileNav.contains(e.target) && !menuBtn.contains(e.target)) {
      closeNav();
    }
  }

  function handleEscape(e: any) {
    if (e.key === "Escape") closeNav();
  }

  function handleResize() {
    if (window.innerWidth >= 768) closeNav();
  }

  menuBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    const isOpen = !mobileNav.classList.contains("hidden");
    isOpen ? closeNav() : openNav();
  });

  navLinks.forEach((link) => link.addEventListener("click", closeNav));
</script>
